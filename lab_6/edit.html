<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–õ–†-6 ¬∑ –î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (fetch)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b2d63;--line:#3a67b5;--text:#eef3ff;--muted:#b8c7f1;--accent:#2b7cff;--accent2:#4d93ff}
    *{box-sizing:border-box} body{margin:0;font:15px/1.45 system-ui;background:#0b2d63 linear-gradient(180deg,#0b2d63,#0a3f8a 55%,#0b2d63);color:var(--text)}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;background:#092a5ae6;border-bottom:1px solid var(--line);backdrop-filter:blur(8px)}
    .wrap{max-width:720px;margin:0 auto;padding:14px 18px;display:flex;gap:12px;align-items:center}.sp{flex:1}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer}
    .btn:hover{background:#0a3f8a77}.btn.acc{background:var(--accent);border-color:transparent;color:#061933}
    .btn.acc:hover{background:var(--accent2)}
    main{max-width:720px;margin:0 auto;padding:22px}
    form{display:grid;gap:12px;background:rgba(10,63,138,.25);border:1px solid var(--line);border-radius:14px;padding:16px}
    label{display:grid;gap:6px}
    input{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0a2f66;color:var(--text)}
    .row{display:flex;gap:12px;align-items:center}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <strong>–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</strong><div class="sp"></div>
    <a class="btn" href="index.html">–ö —Å–ø–∏—Å–∫—É</a>
  </div>
</header>

<main>
  <form id="f">
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ<input name="name" required placeholder="–ù–∞–ø—Ä. –ë–∞–Ω–∞–Ω" /></label>
    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è<input name="category" required placeholder="—Ñ—Ä—É–∫—Ç—ã / –º–æ–ª–æ—á–Ω–æ–µ" /></label>
    <label>–¶–µ–Ω–∞ (RUB)<input name="price" required type="number" min="0" step="1" /></label>
    <label>Emoji<input name="emoji" required placeholder="üçå" /></label>
    <div class="row">
      <button class="btn acc" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <a class="btn" id="cancel" href="index.html">–û—Ç–º–µ–Ω–∞</a>
      <span id="status" style="color:var(--muted)"></span>
    </div>
  </form>
</main>

<script>
const API='http://localhost:5001/api/products';
const id = new URLSearchParams(location.search).get('id');

const form = document.getElementById('f');
const statusEl = document.getElementById('status');

const getItem = async (id)=>{
  const r = await fetch(`${API}/${encodeURIComponent(id)}`, {mode:'cors'});
  if(!r.ok) throw new Error('load');
  return r.json();
};

const saveItem = async (body)=>{
  const method = id ? 'PUT' : 'POST';
  const url = id ? `${API}/${encodeURIComponent(id)}` : API;
  const r = await fetch(url, {
    method, mode:'cors',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok) throw new Error('save');
  return r.json();
};

if(id){
  getItem(id).then(it=>{
    form.name.value = it.name;
    form.category.value = it.category;
    form.price.value = it.price;
    form.emoji.value = it.emoji || 'üõí';
  }).catch(()=> statusEl.textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.');
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const body = {
    name: form.name.value.trim(),
    category: form.category.value.trim(),
    price: Number(form.price.value),
    emoji: form.emoji.value.trim()
  };
  try{
    statusEl.textContent='–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶';
    await saveItem(body);
    location.href = id ? `details.html?id=${encodeURIComponent(id)}` : 'index.html';
  }catch{
    statusEl.textContent='–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.';
  }
});
</script>
</body>
</html>
